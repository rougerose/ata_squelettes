var atlas=function(t){"use strict";function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function a(t,e,a){return e&&i(t.prototype,e),a&&i(t,a),t}function n(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(t)))return;var i=[],a=!0,n=!1,s=void 0;try{for(var o,r=t[Symbol.iterator]();!(a=(o=r.next()).done)&&(i.push(o.value),!e||i.length!==e);a=!0);}catch(t){n=!0,s=t}finally{try{a||null==r.return||r.return()}finally{if(n)throw s}}return i}(t,e)||s(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(t,e){if(t){if("string"==typeof t)return o(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?o(t,e):void 0}}function o(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,a=new Array(e);i<e;i++)a[i]=t[i];return a}function r(t,e){var i;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(i=s(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var a=0,n=function(){};return{s:n,n:function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,r=!0,l=!1;return{s:function(){i=t[Symbol.iterator]()},n:function(){var t=i.next();return r=t.done,t},e:function(t){l=!0,o=t},f:function(){try{r||null==i.return||i.return()}finally{if(l)throw o}}}}var l=768,d={xs:34,s:44,m:54,l:64,xl:74,xxl:84},c={id:"#SearchBox",btnAdvancedId:"#openAdvancedSearch",panelClassName:"mp-SearchBox_Panel"},h={ulClassName:"mp-Keywords_List",liClassName:{main:"mp-Keywords_Item",variant:"mp-Keywords_Item-selected"},labelClassName:"mp-Keywords_Label",btnDeleteClassName:"mp-Keywords_BtnDelete"},u={setTabIndex:!0,openedClass:"is-opened",closedClass:"is-closed",bottomBarClass:"mp-Modal_Bar",containerId:"Modal"};var b=function(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)},m="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},p="object"==typeof m&&m&&m.Object===Object&&m,y="object"==typeof self&&self&&self.Object===Object&&self,f=p||y||Function("return this")(),v=function(){return f.Date.now()},_=f.Symbol,g=Object.prototype,k=g.hasOwnProperty,w=g.toString,x=_?_.toStringTag:void 0;var A=function(t){var e=k.call(t,x),i=t[x];try{t[x]=void 0;var a=!0}catch(t){}var n=w.call(t);return a&&(e?t[x]=i:delete t[x]),n},S=Object.prototype.toString;var I=function(t){return S.call(t)},C=_?_.toStringTag:void 0;var T=function(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":C&&C in Object(t)?A(t):I(t)};var O=function(t){return null!=t&&"object"==typeof t};var E=function(t){return"symbol"==typeof t||O(t)&&"[object Symbol]"==T(t)},M=/^\s+|\s+$/g,P=/^[-+]0x[0-9a-f]+$/i,K=/^0b[01]+$/i,j=/^0o[0-7]+$/i,B=parseInt;var H=function(t){if("number"==typeof t)return t;if(E(t))return NaN;if(b(t)){var e="function"==typeof t.valueOf?t.valueOf():t;t=b(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=t.replace(M,"");var i=K.test(t);return i||j.test(t)?B(t.slice(2),i?2:8):P.test(t)?NaN:+t},W=Math.max,N=Math.min;var D=function(t,e,i){var a,n,s,o,r,l,d=0,c=!1,h=!1,u=!0;if("function"!=typeof t)throw new TypeError("Expected a function");function m(e){var i=a,s=n;return a=n=void 0,d=e,o=t.apply(s,i)}function p(t){return d=t,r=setTimeout(f,e),c?m(t):o}function y(t){var i=t-l;return void 0===l||i>=e||i<0||h&&t-d>=s}function f(){var t=v();if(y(t))return _(t);r=setTimeout(f,function(t){var i=e-(t-l);return h?N(i,s-(t-d)):i}(t))}function _(t){return r=void 0,u&&a?m(t):(a=n=void 0,o)}function g(){var t=v(),i=y(t);if(a=arguments,n=this,l=t,i){if(void 0===r)return p(l);if(h)return clearTimeout(r),r=setTimeout(f,e),m(l)}return void 0===r&&(r=setTimeout(f,e)),o}return e=H(e)||0,b(i)&&(c=!!i.leading,s=(h="maxWait"in i)?W(H(i.maxWait)||0,e):s,u="trailing"in i?!!i.trailing:u),g.cancel=function(){void 0!==r&&clearTimeout(r),d=0,a=l=n=r=void 0},g.flush=function(){return void 0===r?o:_(v())},g};const F=["hide","show"];class q{constructor(t){if(!t||!t.nodeName)throw new Error("No DOM node provided. Abort.");this.el=t,this._tablist={},this._callbacks={},this._handleDisplay=this._handleDisplay.bind(this),this._handleFocus=this._handleFocus.bind(this),this._handleTab=this._handleTab.bind(this),this._handlePanelFocus=this._handlePanelFocus.bind(this),this._handlePanel=this._handlePanel.bind(this)}_firstActiveTab(){let t;for(let e=0;e<this._tablist.tabs.length;e++)if(!this._tablist.tabs[e].disabled){t=e;break}return t}_handleDisplay(t){t.preventDefault();const e=t.currentTarget;e.disabled||(e!==document.activeElement&&e.focus(),this._toggleDisplay(this._tablist.tabs.indexOf(e)))}_handleFocus(t){const e=t.currentTarget;e.disabled||(this._tablist.currentTabIndex=this._tablist.tabs.indexOf(e),this._select(this._tablist.tabs[this._tablist.currentTabIndex]))}_handlePanel(t){switch(void 0===this._tablist.currentTabIndex&&this._handlePanelFocus(t),t.keyCode){case 33:t.ctrlKey&&(t.preventDefault(),this._switchTab(this._tablist.currentTabIndex-1));break;case 34:t.ctrlKey&&(t.preventDefault(),this._switchTab(this._tablist.currentTabIndex+1));break;case 38:t.ctrlKey&&(t.preventDefault(),this._switchTab(this._tablist.currentTabIndex))}}_handlePanelFocus(t){if(t.target.doubleFocus)return t.preventDefault(),void delete t.target.doubleFocus;const e=t.currentTarget;this._tablist.currentTabIndex=this._tablist.tabPanels.indexOf(e),["radio","checkbox"].indexOf(t.target.type)>=0&&(t.target.doubleFocus=!0)}_handleTab(t){switch(void 0===this._tablist.currentTabIndex&&this._handleFocus(t),t.keyCode){case 32:case 13:this._handleDisplay(t);break;case 35:t.preventDefault(),this._switchTab(this._tablist.tabs.length-1);break;case 36:t.preventDefault(),this._switchTab(this._firstActiveTab());break;case 37:case 38:t.preventDefault(),this._switchTab(this._tablist.currentTabIndex-1);break;case 39:case 40:t.preventDefault(),this._switchTab(this._tablist.currentTabIndex+1)}}_noop(){}_select(t){this._tablist.tabs.forEach(((e,i)=>{const a=t===e;e.setAttribute("aria-selected",a),e.setAttribute("tabindex",a?0:-1),a&&this._toggleDisplay(i)}))}_switchTab(t){if(this._tablist.tabs[t]&&this._tablist.tabs[t].disabled){const e=t>this._tablist.currentTabIndex?t+1:t-1;this._switchTab(e)}else this._tablist.currentTabIndex=t,this._tablist.currentTabIndex<this._firstActiveTab()?this._tablist.currentTabIndex=this._tablist.tabsLength-1:this._tablist.currentTabIndex>=this._tablist.tabsLength&&(this._tablist.currentTabIndex=this._firstActiveTab()),this._tablist.tabs[this._tablist.currentTabIndex].focus()}_toggleDisplay(t,e=!0){if(e&&t===this._tablist.openedIndex)return;const i=this._tablist.tabs[t],a=this._tablist.tabPanels[t];e&&void 0!==this._tablist.openedIndex&&this._toggleDisplay(this._tablist.openedIndex,!1),a.setAttribute("aria-hidden",!e),e?(this._tablist.openedIndex=t,void 0!==this._tablist.openedIndex&&this._trigger("show",[i,a])):void 0!==this._tablist.openedIndex&&this._trigger("hide",[i,a])}_trigger(t,e){this._callbacks[t]&&this._callbacks[t].forEach((t=>{t.apply(this,e)}))}mount(){let t;this._tablist.tabs=[],this._tablist.tabPanels=[],Array.from(this.el.querySelectorAll("[role=tab]")).forEach(((e,i)=>{const a=e.getAttribute("aria-controls");let n,s=!1;if(a?n=document.getElementById(a):e.nextElementSibling&&e.nextElementSibling.getAttribute("aria-labelledby")===e.id&&(n=e.nextElementSibling),!n)throw new Error(`Could not find associated tabpanel for tab ${e.id}. Use [aria-controls="tabpanelId"] on the [role="tab"] element to link them together`);this._tablist.tabs.push(e),this._tablist.tabPanels.push(n),e.disabled=e.hasAttribute("disabled")||"true"===e.getAttribute("aria-disabled"),"true"!==e.getAttribute("data-open")||e.disabled||void 0===this._tablist.openedIndex&&(this._toggleDisplay(i,!0),s=!0),e.removeAttribute("data-open"),void 0!==t||e.disabled||(t=i),e.setAttribute("tabindex",-1),n.setAttribute("aria-hidden",!s),e.addEventListener("click",this._handleDisplay),e.addEventListener("focus",this._handleFocus),e.addEventListener("keydown",this._handleTab),n.addEventListener("focus",this._handlePanelFocus,!0),n.addEventListener("keydown",this._handlePanel)})),this._tablist.tabsLength=this._tablist.tabs.length,this._tablist.tabPanelsLength=this._tablist.tabPanels.length,void 0!==this._tablist.openedIndex?(this._tablist.tabs[this._tablist.openedIndex].setAttribute("tabindex",0),this._tablist.tabs[this._tablist.openedIndex].setAttribute("aria-selected","true")):(this._toggleDisplay(t,!0),this._tablist.tabs[t].setAttribute("tabindex",0),this._tablist.tabs[t].setAttribute("aria-selected","true"))}off(t,e){if(!this._callbacks[t])return;const i=this._callbacks[t].indexOf(e);i<0||this._callbacks[t].splice(i,1)}on(t,e){F.indexOf(t)<0||(this._callbacks[t]||(this._callbacks[t]=[]),this._callbacks[t].push(e))}get current(){return{tab:this._tablist.tabs[this._tablist.openedIndex],tabPanel:this._tablist.tabPanels[this._tablist.openedIndex]}}unmount(){this._tablist.tabs.forEach(((t,e)=>{const i=this._tablist.tabPanels[e];t.removeEventListener("click",this._handleDisplay),t.removeEventListener("focus",this._handleFocus),t.removeEventListener("keydown",this._handleTab),t.removeAttribute("tabindex"),t.removeAttribute("aria-selected"),i.removeEventListener("focus",this._handlePanelFocus,!0),i.removeEventListener("keydown",this._handlePanel),i.setAttribute("aria-hidden","false")})),this._tablist={}}}var z=function(){function t(i,a,n){e(this,t),this.map=i,this.configMap(),this.handleResize=this._handleResize.bind(this),window.addEventListener("resize",D(this.handleResize,250)),this.container=document.getElementById(n.containerId),this.dispatch=n.dispatch,this.state=a,this.memory={};var s=n.controls,o=this.container,r=this.dispatch;this.controls=s.map((function(t){return new t(a,{container:o,dispatch:r})}));var l=this.container.querySelector("#Tab ul[role='tablist']");l&&new q(l).mount()}return a(t,[{key:"configMap",value:function(){var t=this;L.Util.setOptions(this.map,{tap:!1}),L.Control.Attribution.prototype.options.position="bottomleft",L.Control.Zoom.prototype.options.position="bottomright";var e=L.easyButton({position:"bottomright",states:[{stateName:"add-association",icon:'<span class="mp-ControlAddBtn"> </span>',onClick:function(){location.href="https://docs.google.com/forms/d/e/1FAIpQLSdSSlbwy710Qu9XRhUwpzyZ2BjKXnzZV8S4Z62CjaKaEYwWYw/viewform"}}]});e.button.title="Ajouter une association",e.addTo(this.map);jQuery("#"+this.map._container.id).on("ready",(function e(){t.setInitialState(),t._handleClickMarker(),t.map.options.openId&&(t.map.options.openId,t.dispatch({type:"addModalContent",openId:t.map.options.openId,modalId:"modalAssociation"})),jQuery("#"+t.map._container.id).off("ready",e)})),this.map.options.cluster&&(this.map.options.clusterOptions.iconCreateFunction=this.clusterIcon)}},{key:"clusterIcon",value:function(t){var e,i,a,n=d;return(a=t.getChildCount())<=3?(i="-xs",e=n.xs):a<=10?(i="-s",e=n.s):a<=50?(i="-m",e=n.m):a<=100?(i="-l",e=n.l):a<=250?(i="-xl",e=n.xl):(i="-xxl",e=n.xxl),new L.DivIcon({html:"<div><span>"+a+"</span></div>",className:"mp-MarkerCluster mp-MarkerCluster"+i,iconSize:new L.Point(e,e)})}},{key:"syncState",value:function(t){t.keywordsSelected.size!==this.state.keywordsSelected.size&&(0!==t.keywordsSelected.size?(this.searchCollection(t.keywordsSelected),this.state=t):(this.resetMap(),this.state=t)),Object.keys(t.centerMarker).length>0&&this.centerOnMarker(t.centerMarker.id),""!==t.moveZoom&&this.moveZoom(t.moveZoom),this.state=t;var e,i=r(this.controls);try{for(i.s();!(e=i.n()).done;){e.value.syncState(t)}}catch(t){i.e(t)}finally{i.f()}}},{key:"setInitialState",value:function(){var t=this;t.state.windowWidth||t.dispatch({type:"updateWindowWidth",windowWidth:t._getWindowWidth()})}},{key:"_handleResize",value:function(t){this._checkWindowWidth()}},{key:"_handleClickMarker",value:function(){var t=this,e={},i=function(e){t.dispatch({type:"addModalContent",openId:this.feature.id,modalId:"modalAssociation"}),t.dispatch({type:"centerOnMarker",id:this.feature.id})};this.map.markerCluster.eachLayer((function(t){e[t.id]=t,t.on("click",i)})),this.memory.markers=e}},{key:"_getWindowWidth",value:function(){var t=l;return window.innerWidth>=t?"desktop":"mobile"}},{key:"_checkWindowWidth",value:function(){var t=this._getWindowWidth();this.state.windowWidth!==t&&this.dispatch({type:"updateWindowWidth",windowWidth:t})}},{key:"handleAction",value:function(t,e){0==t.keywords.size&&t.keywordsSelected.size>0&&(t.keywordsSelected=new Map);var i,a,n=this.state;switch(n.modalAction="",n.modalArgs={},n.modalOpenId="",n.modalId="",n.centerMarker={},n.moveZoom="",e.type){case"addKeyword":i=new Map(t.keywords),a=new Map(t.keywordsSelected),i.set(e.keyword.value,e.keyword.label),a.set(e.keyword.value,e.keyword.label),t=Object.assign({},n,{keywords:i,keywordsSelected:a});break;case"removeKeywordSelected":i=new Map(t.keywords),a=new Map(t.keywordsSelected),i.delete(e.keyword.value),a.delete(e.keyword.value),t=Object.assign({},n,{keywords:i,keywordsSelected:a});break;case"addModalContent":e.action="addModalContent",e.modalId=e.modalId,e.openId=e.openId||"",e.args=e.args||{},t=Object.assign({},n,{modalAction:e.action,modalOpenId:e.openId,modalArgs:e.args,modalId:e.modalId});break;case"updateModalPosition":e.action=e.action||"",e.modalId=e.modalId||"",e.openId=e.openId||"",e.args=e.args||{},t=Object.assign({},n,{modalAction:e.action,modalOpenId:e.openId,modalArgs:e.args,modalId:e.modalId});break;case"updateWindowWidth":t=Object.assign({},n,{windowWidth:e.windowWidth});break;case"updateSearchboxHeight":e.searchboxHeight||(e.searchboxHeight=null),t=Object.assign({},n,{searchboxHeight:e.searchboxHeight});break;case"centerOnMarker":t=Object.assign({},n,{centerMarker:{id:e.id}});break;case"moveZoom":t=Object.assign({},n,{moveZoom:e.height})}return t}},{key:"autocompleteAddKeyword",value:function(t){this.dispatch({type:"addKeyword",keyword:t})}},{key:"centerOnMarker",value:function(t){var e=this,i=this.memory.markers[t];this.map.getZoom(),this.map.markerCluster.zoomToShowLayer(i,(function(){var t=i._latlng,a=i.__parent.getBounds(),n=e.map.getBoundsZoom(a);if("desktop"===e.state.windowWidth){var s=e.container.querySelector(c.id).offsetWidth,o=L.latLngBounds([t]),r={paddingTopLeft:[s,10],maxZoom:n};e.map.fitBounds(o,r)}else e.map.setView(t,n);i.openPopup()}))}},{key:"moveZoom",value:function(t){this.map.zoomControl.getContainer().parentElement.style.transform="translateY("+t+"px)"}},{key:"resetMap",value:function(){var t=this;this.map.removeAllMarkers(),this.map.loadData(),this.dispatch({type:"updateModalPosition",action:"closeModals"});jQuery("#"+this.map._container.id).on("ready",(function(){t._handleClickMarker()}))}},{key:"createQuery",value:function(t){var e,i={id_association:[],id_mot:[],id_adresse:[],limit:this.map.options.json_points.limit},a=r(t);try{for(a.s();!(e=a.n()).done;){var s=n(e.value,1)[0].split(":"),o=i[s[0]].length;i[s[0]][o]=s[1]}}catch(t){a.e(t)}finally{a.f()}return i}},{key:"searchCollection",value:function(t){var e=this,i=e.map,a=e.createQuery(t);a=jQuery.param(a);var n=jQuery.getJSON("http.api/collectionjson/associations",a),s={id_association:[]};n.done((function(t){var a=t.collection.items;for(var n in a)Object.hasOwnProperty.call(a,n)&&s.id_association.push(a[n].data[0].value);var o={};jQuery.extend(!0,o,i.options.json_points.env,s),o.objets="associations_recherche",o.limit=i.options.json_points.limit,e.searchFeatures(i.options.json_points.url,o)})),n.fail((function(t,i,a){s.id_association.push(0),e.dispatch({type:"addModalContent",args:s,modalId:"modalRecherche"})}))}},{key:"searchFeatures",value:function(t,e){var i=this,a=i.map;jQuery.getJSON(t,e,(function(t){if(t){a.removeAllMarkers();var n;n=t.features.map((function(t){return t.geometry.coordinates.slice().reverse()}));var s=L.latLngBounds(n);a.parseGeoJson(t),a.fitBounds(s),i._handleClickMarker(),i.dispatch({type:"addModalContent",args:e,modalId:"modalRecherche"})}}))}}]),t}(),Z=function(){function t(i,a){var n=a.container,s=a.dispatch;e(this,t),this.state=i,this._container=n.querySelector(c.id),this._advancedSearchIsOpen=!1,this.dispatch=s,this._initLayout(this._container)}return a(t,[{key:"_getHeight",value:function(){return this._container.offsetHeight}},{key:"getWidth",value:function(){return this._container.offsetWidth}},{key:"updateHeight",value:function(t){var e=t||this._getHeight();this.dispatch({type:"updateSearchboxHeight",searchboxHeight:e})}},{key:"_initLayout",value:function(t){var e=this;if(this._inputs=t.querySelectorAll("input[type=text]"),[].forEach.call(this._inputs,(function(t){t.addEventListener("focus",e._handlerInputEvent),t.addEventListener("blur",e._handlerInputEvent)})),this._cancelBtns=t.querySelectorAll("button[type=reset]"),[].forEach.call(this._cancelBtns,(function(i){var a=i.dataset.relId,n=t.querySelector("[data-id='"+a+"']");i.addEventListener("click",e._onclickCancelBtn.bind(n))})),this._advancedSearchBtn=t.querySelector(c.btnAdvancedId),this._advancedSearchBtn.addEventListener("click",(function(){e._togglePanels()})),this._panels=t.querySelectorAll("."+c.panelClassName),!this._advancedSearchIsOpen)for(var i=0;i<this._panels.length;i++){var a=this._panels[i];0==i?a.setAttribute("aria-hidden","false"):a.setAttribute("aria-hidden","true")}}},{key:"_togglePanels",value:function(){var t=this._advancedSearchIsOpen?0:1;this._advancedSearchIsOpen?(this._advancedSearchBtn.setAttribute("aria-expanded","false"),this._advancedSearchBtn.classList.remove("is-open"),this._advancedSearchIsOpen=!1):(this._advancedSearchBtn.setAttribute("aria-expanded","true"),this._advancedSearchBtn.classList.add("is-open"),this._advancedSearchIsOpen=!0);var e=this._panels[1-t],i=this._panels[t];this.close(e),this.open(i)}},{key:"close",value:function(t){t.setAttribute("aria-hidden","true")}},{key:"open",value:function(t){t.setAttribute("aria-hidden","false"),this.updateHeight()}},{key:"_handlerInputEvent",value:function(t){var e=this.offsetParent;"focus"===t.type?e.classList.add("is-focused"):"blur"===t.type&&""===t.target.value&&e.classList.remove("is-focused")}},{key:"_onclickCancelBtn",value:function(t){t.preventDefault();this.value=null,this.offsetParent.classList.remove("is-focused")}},{key:"syncState",value:function(t){if(this.state=t,null===this.state.searchboxHeight){var e=this._getHeight();this.state.searchboxHeight=e,this.updateHeight(e)}}}]),t}(),R=function(){function t(i,a){var n=a.container,s=a.dispatch;e(this,t),this.state=i,this.dispatch=s,this.container=n.querySelector("#Keyword"),this.listbox=n.querySelector("#listBox"),this.options={prevKeys:37,nextKeys:39},this._setupOptions(this.options),this._handleClick=this._handleClick.bind(this),this._handleKeydown=this._handleKeydown.bind(this),this._mount()}return a(t,[{key:"syncState",value:function(t){if(t.keywords.size!==this.state.keywords.size)if(0===t.keywords.size)this._clearTabIndexes(),this._clearAllSelectedItems(),this.state.keywords=t.keywords;else{this._clearTabIndexes(),this._clearAllSelectedItems(),this.state.keywords=t.keywords;var e,i=r(t.keywords);try{for(i.s();!(e=i.n()).done;){var a=n(e.value,1)[0],s=this.listbox.querySelector('li[data-value="'+a+'"]');s&&this._select(s)}}catch(t){i.e(t)}finally{i.f()}}this.state=t}},{key:"dispatchAction",value:function(t,e){this.dispatch({type:t,keyword:e})}},{key:"add",value:function(t){this.state.keywords.has(t.value)||this.dispatchAction("addKeyword",t)}},{key:"remove",value:function(t){this.state.keywords.has(t.value)&&this.dispatchAction("removeKeyword",t)}},{key:"_setupOptions",value:function(t){var e=t||{};e.prevKeys=this._normalizeKeyOptions(e.prevKeys,[38]),e.nextKeys=this._normalizeKeyOptions(e.nextKeys,[40]),e.selectKeys=this._normalizeKeyOptions(e.selectKeys,[13,32]),this.options=e}},{key:"_normalizeKeyOptions",value:function(t,e){return Array.isArray(t)||(t=t?[t]:e),t.map((function(t){return"string"!=typeof t||Number(t)?Number(t):t.charCodeAt(0)}))}},{key:"_clearTabIndexes",value:function(){for(var t=this.listbox.querySelectorAll("[tabindex]"),e=0;e<t.length;e++)t[e].removeAttribute("tabindex")}},{key:"_clearAllSelectedItems",value:function(){for(var t=this.listbox.querySelectorAll("[aria-selected=true]"),e=0;e<t.length;e++)t[e].setAttribute("aria-selected","false")}},{key:"_handleClick",value:function(t){t.preventDefault();var e=this._optionNode(t);e&&this._select(e)}},{key:"_handleKeydown",value:function(t){var e=this._optionNode(t),i=t.keyCode||t.code;e&&(-1!==this.options.selectKeys.indexOf(i)?this._select(e):t.target&&"option"===t.target.getAttribute("role")&&(this._handleKey(e,i,this.options.nextKeys,1),this._handleKey(e,i,this.options.prevKeys,-1)))}},{key:"_handleKey",value:function(t,e,i,a){if(-1!==i.indexOf(e)){var n=this.listbox.querySelectorAll('[role="option"]:not([aria-disabled="true"])'),s=n[Array.prototype.indexOf.call(n,t)+a];s&&(this._clearTabIndexes(),s.setAttribute("tabindex",0),s.focus())}}},{key:"_mount",value:function(){var t=this.listbox.querySelector('[aria-selected="true"]');if(t)t.setAttribute("tabindex","0");else{var e=this.listbox.querySelectorAll('[role="option"]:not([aria-disabled="true"])');e.length&&e[0].setAttribute("tabindex",0)}this.listbox.addEventListener("click",this._handleClick),this.listbox.addEventListener("keydown",this._handleKeydown)}},{key:"_select",value:function(t){if("true"!==t.getAttribute("aria-disabled")){var e="true"===this.listbox.getAttribute("aria-multiselectable");e||this._clearAllSelectedItems(),e&&"true"===t.getAttribute("aria-selected")||(this._clearTabIndexes(),t.setAttribute("aria-selected","true"),t.setAttribute("tabindex","0"),t.focus(),e&&this.add({value:t.dataset.value,label:t.dataset.label}))}}},{key:"_optionNode",value:function(t){for(var e=t.target;e&&"option"!==e.getAttribute("role");)e=e.parentElement;return e}}]),t}(),Q=function(){function t(i,a){var n=this,s=a.container,o=a.dispatch;e(this,t),this.state=i,this.dispatch=o,this.container=s.querySelector("#KeywordSelected"),this._deleteListener=this._deleteEvent.bind(this),this.container.addEventListener("animationstart",(function(){n.dispatch({type:"updateSearchboxHeight",searchboxHeight:null})}))}return a(t,[{key:"syncState",value:function(t){t.keywordsSelected.size!==this.state.keywordsSelected.size&&(this.state=t,t.keywordsSelected.size>0&&this.updateKeywordSelectedList()),this.state=t}},{key:"updateKeywordSelectedList",value:function(){for(var t=this.getUL(),e=t.querySelectorAll("li"),i=0;i<e.length;i++)this.removeKeyword(e[i],!1);var a,s=r(this.state.keywordsSelected);try{for(s.s();!(a=s.n()).done;){var o=n(a.value,2),l=o[0],d=o[1],c=this.addKeyword(l,d);t.appendChild(c)}}catch(t){s.e(t)}finally{s.f()}this.dispatch({type:"updateKeywordSelectedList"})}},{key:"dispatchAction",value:function(t,e){this.dispatch({type:t,keyword:e})}},{key:"getUL",value:function(){var t=this.container.firstElementChild;return t||((t=document.createElement("ul")).className=h.ulClassName,this.container.appendChild(t)),t}},{key:"addKeyword",value:function(t,e){return this._addMarkupLi(t,e)}},{key:"removeKeyword",value:function(t,e){var i=t.parentNode;t.remove(),e&&!i.firstElementChild&&(i.remove(),this.dispatch({type:"updateSearchboxHeight",searchboxHeight:null}))}},{key:"_deleteEvent",value:function(t){var e=t.target;e.removeEventListener("click",this._deleteListener);var i=e.parentElement;this.removeKeyword(i,!0);var a={value:i.dataset.value,label:i.dataset.label};this.dispatchAction("removeKeywordSelected",a)}},{key:"_addMarkupLi",value:function(t,e){var i,a=document.createElement("li"),n=h.liClassName.main,s=h.liClassName.variant;switch(t.split(":")[0]){case"id_association":i="-org";break;case"id_adresse":i="-city";break;case"id_mot":i="-activity"}var o=n;o+=" "+n+i,o+=" "+s,a.className=o,a.dataset.value=t,a.dataset.label=e;var r=document.createElement("span");r.className=h.labelClassName,r.appendChild(document.createTextNode(e));var l=document.createElement("button");return l.className="o-btn "+h.btnDeleteClassName,l.setAttribute("aria-label","Supprimer ce critère de recherche"),l.addEventListener("click",this._deleteListener),a.appendChild(r),a.appendChild(l),a}}]),t}();function U(){}function Y(t,e){if(!e)return t&&t.then?t.then(U):Promise.resolve()}function $(t,e){var i=t();return i&&i.then?i.then(e):e(i)}function V(t,e,i){return i?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}var X,G=function(){function t(i,a){var n=a.container,s=a.dispatch;e(this,t),this.state=i,this.dispatch=s,this.atlasContainer=n,this.modals={},this.memory={modalAssociation:{position:"",btns:[],transitions:{transitionOn:"",transitionOnPreview:"",transitionOff:""}},modalRecherche:{position:"",btns:[],transitions:{transitionOn:"",transitionOnPreview:null,transitionOff:""}},previewHeight:"",bottomBarHeight:"",working:!1},this.setUpModal(),this._handlerClickBtns=this.handlerClickBtns.bind(this),this._handlerClickList=this.handlerClickList.bind(this)}return a(t,[{key:"syncState",value:function(t){"addModalContent"===t.modalAction?this.addContent(t):"closeModals"===t.modalAction?this.closeAllModals():"desktop"!==t.windowWidth||t.windowWidth!==this.state.windowWidth||t.searchboxHeight===this.state.searchoxHeight||"openedFull"!==this.state.modalAssociation&&"openedFull"!==this.state.modalRecherche||this.updateLayout(t.searchboxHeight),this.state=t}},{key:"addContent",value:function(t){try{var e,i,a=this,n=t.modalId;return t.modalOpenId?(e={id_gis:t.modalOpenId},i=!0):t.modalArgs&&(e={id_association:t.modalArgs.id_association},i=!1),$((function(){if("closed"!==a.memory[n].position)return Y(a.close(n,!0))}),(function(){return $((function(){if("modalRecherche"===n&&"closed"!==a.memory.modalAssociation.position)return Y(a.close("modalAssociation",!0))}),(function(){window.ajaxReload(n,{callback:function(){var t=a.atlasContainer.querySelector("#"+n);a.modals[n]=t,a.bindListeners(n),a.setPosition(n),"modalRecherche"===n&&"mobile"===a.state.windowWidth?a.toggleVisibility(n):a.open(n,!0)},args:e,history:i})}))}))}catch(t){return Promise.reject(t)}}},{key:"closeAllModals",value:function(){for(var t in this.memory.working=!0,this.modals){var e=this.modals[t].id;"closed"!==this.memory[e].position&&this.close(e,!0)}"mobile"===this.state.windowWidth&&(this.memory.bottomBarHeight="",this.dispatch({type:"moveZoom",height:0})),this.memory.working=!1}},{key:"close",value:function(t,e){try{var i=this,a=i.modals[t],n=void 0===e||e;return n||"modalRecherche"!==t||"mobile"!==i.state.windowWidth||(a=a.firstElementChild.firstElementChild,n=!1),i.memory.working=!0,V(i.closeTransition(a,i.memory[t].transitions.transitionOff,n),(function(){return n?(i.memory[t].position="closed",i.unbindListeners(t),"mobile"===i.state.windowWidth&&"closed"===i.memory.modalRecherche.position&&i.dispatch({type:"moveZoom",height:0})):i.memory[t].position="visible",i.memory.working=!1,a}))}catch(t){return Promise.reject(t)}}},{key:"open",value:function(t,e){try{var i,a,n,s=this,o=s.modals[t],r=void 0===e||e;return"modalRecherche"===t&&"mobile"===s.state.windowWidth&&(o=o.firstElementChild.firstElementChild,r=!1,n=s.memory.bottomBarHeight),"openedPreview"===s.memory[t].position?(i=s.memory[t].transitions.transitionOnPreview,a="is-toggle-up","closed"===s.memory.modalRecherche.position&&(n=s.memory.previewHeight)):(i=s.memory[t].transitions.transitionOn,a="is-toggle-down"),s.memory.working=!0,V(s.openTransition(o,i,r),(function(){return s.memory[t].btns.forEach((function(t){t.classList.add("is-ready-to-animate"),"toggle"===t.dataset.modalAction&&t.classList.add(a)})),void 0!==n&&s.dispatch({type:"moveZoom",height:n}),s.memory.working=!1,o}))}catch(t){return Promise.reject(t)}}},{key:"toggleVisibility",value:function(t){var e=this.modals[t];"false"===e.getAttribute("aria-hidden")?(e.setAttribute("aria-hidden","true"),this.memory[t].position="closed"):(e.setAttribute("aria-hidden","false"),this.memory[t].position="visible",this.dispatch({type:"moveZoom",height:this.memory.bottomBarHeight}))}},{key:"bindListeners",value:function(t){var e=this,i=this.modals[t],a=i.querySelectorAll("button");if(this.memory[t].btns=a,a.forEach((function(i){i.addEventListener("click",e._handlerClickBtns),i.setAttribute("tabindex","0"),"modalAssociation"===t&&e.setAnimationBtn(i)})),"modalRecherche"===t){var n=i.querySelectorAll("li");this.memory[t].list=n,n.forEach((function(t){t.addEventListener("click",e._handlerClickList)}))}}},{key:"unbindListeners",value:function(t){var e=this;this.memory[t].btns.forEach((function(t){t.removeEventListener("click",e._handlerClickBtns),t.setAttribute("tabindex","-1")}));var i=this.memory[t].list;void 0!==i&&i.length>0&&i.forEach((function(t){t.removeEventListener("click",e._handlerClickList)}))}},{key:"calcBottomBarHeight",value:function(t){var e=t.querySelector("."+u.bottomBarClass);return-Math.abs(e.offsetHeight)}},{key:"calcPreviewHeight",value:function(t){var e=t.querySelector("article h2");return-Math.abs(e.nextElementSibling.offsetTop+36)}},{key:"getModals",value:function(){return this.atlasContainer.querySelectorAll("[data-modal]")}},{key:"handlerClickBtns",value:function(t){var e=t.target,i=t.target.closest("[data-modal]"),a=i.id,n=t.target.dataset.modalAction,s=this.memory[a].position;if("modalRecherche"===i.id&&"toggle"===n){if(this.memory.working)return;e.getAttribute("data-text-toggle")==e.innerHTML?e.innerHTML=e.getAttribute("data-text-original"):(e.setAttribute("data-text-original",e.innerHTML),e.innerHTML=e.getAttribute("data-text-toggle")),"visible"===s?(this.memory[a].position="openedFull",this.open(a,!1)):(this.memory[a].position="visible",this.close(a,!1))}else if("modalAssociation"===i.id){if(this.memory.working)return;"toggle"===n&&"openedPreview"===s?(this.memory[a].position="openedFull",this.open(a,!1)):this.close(a,!0)}}},{key:"handlerClickList",value:function(t){var e=t.target.closest("[data-id-gis]");e&&(this.dispatch({type:"addModalContent",openId:e.dataset.idGis,modalId:"modalAssociation"}),this.dispatch({type:"centerOnMarker",coords:[e.dataset.lon,e.dataset.lat],id:e.dataset.idGis}))}},{key:"openTransition",value:function(t,e,i){return new Promise((function(a){i&&t.setAttribute("aria-hidden","false"),t.addEventListener("transitionend",(function e(){a(t),this.removeEventListener("transitionend",e)})),t.style.transform=e}))}},{key:"closeTransition",value:function(t,e,i){return new Promise((function(a){t.addEventListener("transitionend",(function e(){i&&t.setAttribute("aria-hidden","true"),t.style.transform="",a(t),this.removeEventListener("transitionend",e)})),t.style.transform=e}))}},{key:"setAnimationBtn",value:function(t){var e=t.querySelector("circle");if(e){var i=(2*Math.PI*e.getAttribute("r")).toFixed(2);e.setAttribute("stroke-dashoffset",i),e.setAttribute("stroke-dasharray",i)}}},{key:"setPosition",value:function(t){var e,i,a=this.modals[t];"desktop"===this.state.windowWidth?(this.updateLayout(this.state.searchboxHeight),e="openedFull",i=this.setStyleTransitions(this.state.windowWidth)):"modalAssociation"===t?(e="openedPreview",this.memory.previewHeight=this.calcPreviewHeight(a),i=this.setStyleTransitions(this.state.windowWidth)):(e="openedFull",i=this.setStyleTransitions(this.state.windowWidth),this.memory.bottomBarHeight=this.calcBottomBarHeight(a)),this.memory[t].position=e,this.memory[t].transitions=i}},{key:"setStyleTransitions",value:function(t){var e={};return"desktop"===t?(e.transitionOn="translateX(0)",e.transitionOnPreview=null,e.transitionOff="translateX(-100%)"):(this.memory.previewHeight?e.transitionOnPreview="translateY("+this.memory.previewHeight+"px)":e.transitionOnPreview=null,e.transitionOn="translateY(-100%)",e.transitionOff="translateY(0)"),e}},{key:"setTabIndex",value:function(t,e){e?t.setAttribute("tabindex","-1"):t.removeAttribute("tabindex")}},{key:"setUpModal",value:function(){var t=this,e=this.getModals();e&&e.forEach((function(e){var i=e.id;t.modals[i]=e,e.classList.contains(u.openedClass)||(e.setAttribute("aria-hidden","true"),t.setTabIndex(e,!0),t.memory[i].position="closed")}))}},{key:"updateLayout",value:function(t){for(var e in this.modals){this.modals[e].firstElementChild.firstElementChild.style.paddingTop=t+"px"}}}]),t}(),J={windowWidth:null,searchboxHeight:null,keywords:new Map,keywordsSelected:new Map,modalAction:"",modalArgs:{},modalOpenId:"",modalId:"",centerMarker:{},moveZoom:""};return t.addKeyword=function(t){X.autocompleteAddKeyword(t)},t.init=function(t){var e={containerId:"atlas",controls:[Z,R,Q,G],dispatch:function(t){J=X.handleAction(J,t),X.syncState(J)}};X=new z(t,J,e)},t}({});
